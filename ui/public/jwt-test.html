<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>JWT + ë¦¬í”„ë ˆì‹œ í† í° í…ŒìŠ¤íŠ¸</title>
        <style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
                background: #f5f5f5;
            }
            .container {
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }
            .test-section {
                margin: 20px 0;
                padding: 15px;
                border: 1px solid #ddd;
                border-radius: 5px;
            }
            .success {
                border-color: #4caf50;
                background-color: #f0fff4;
            }
            .error {
                border-color: #f44336;
                background-color: #fff5f5;
            }
            .warning {
                border-color: #ff9800;
                background-color: #fff8f0;
            }
            button {
                background: #499200;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                cursor: pointer;
                margin: 5px;
            }
            button:hover {
                background: #3d7a00;
            }
            .token-display {
                background: #f5f5f5;
                padding: 10px;
                border-radius: 3px;
                font-family: monospace;
                font-size: 12px;
                word-break: break-all;
                margin: 10px 0;
            }
            .status {
                font-weight: bold;
                margin: 10px 0;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>ğŸ” JWT + ë¦¬í”„ë ˆì‹œ í† í° í…ŒìŠ¤íŠ¸</h1>

            <div class="test-section">
                <h3>1. í˜„ì¬ í† í° ìƒíƒœ</h3>
                <button onclick="checkTokenStatus()">í† í° ìƒíƒœ í™•ì¸</button>
                <div id="tokenStatus"></div>
            </div>

            <div class="test-section">
                <h3>2. ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸</h3>
                <p>Google OAuth ë¡œê·¸ì¸ì„ í†µí•´ JWT í† í°ì„ ë°›ì•„ë³´ì„¸ìš”.</p>
                <button onclick="testLogin()">Google ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸</button>
                <div id="loginStatus"></div>
            </div>

            <div class="test-section">
                <h3>3. ë¦¬í”„ë ˆì‹œ í† í° í…ŒìŠ¤íŠ¸</h3>
                <p>í˜„ì¬ ë¦¬í”„ë ˆì‹œ í† í°ìœ¼ë¡œ ìƒˆë¡œìš´ ì•¡ì„¸ìŠ¤ í† í°ì„ ë°›ì•„ë³´ì„¸ìš”.</p>
                <button onclick="testRefreshToken()">í† í° ê°±ì‹  í…ŒìŠ¤íŠ¸</button>
                <div id="refreshStatus"></div>
            </div>

            <div class="test-section">
                <h3>4. í† í° ë§Œë£Œ ì‹œë®¬ë ˆì´ì…˜</h3>
                <p>í† í°ì„ ë¬´íš¨í™”í•˜ì—¬ ìë™ ê°±ì‹  ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸í•´ë³´ì„¸ìš”.</p>
                <button onclick="invalidateToken()">í† í° ë¬´íš¨í™”</button>
                <button onclick="testExpiredToken()">ë§Œë£Œëœ í† í°ìœ¼ë¡œ API í˜¸ì¶œ</button>
                <div id="expiredStatus"></div>
            </div>

            <div class="test-section">
                <h3>5. ë¡œê·¸ì•„ì›ƒ í…ŒìŠ¤íŠ¸</h3>
                <button onclick="testLogout()">ë¡œê·¸ì•„ì›ƒ í…ŒìŠ¤íŠ¸</button>
                <div id="logoutStatus"></div>
            </div>

            <div class="test-section">
                <h3>6. ìë™ ê°±ì‹  ëª¨ë‹ˆí„°ë§</h3>
                <button onclick="startMonitoring()">ìë™ ê°±ì‹  ëª¨ë‹ˆí„°ë§ ì‹œì‘</button>
                <button onclick="stopMonitoring()">ëª¨ë‹ˆí„°ë§ ì¤‘ì§€</button>
                <div id="monitorStatus"></div>
            </div>
        </div>

        <script>
            let monitoringInterval;

            function checkTokenStatus() {
                const cookies = document.cookie;

                let html = '<div class="status">í† í° ìƒíƒœ:</div>';

                // ì•¡ì„¸ìŠ¤ í† í° ì¿ í‚¤ í™•ì¸
                const accessTokenCookie = cookies.split("; ").find((row) => row.startsWith("accessToken="));
                if (accessTokenCookie) {
                    const accessToken = accessTokenCookie.split("=")[1];
                    html += `<div class="success">âœ… ì•¡ì„¸ìŠ¤ í† í° ì¿ í‚¤ ì¡´ì¬</div>`;

                    // JWT ë””ì½”ë”© (ê°„ë‹¨í•œ ë°©ë²•)
                    try {
                        const payload = JSON.parse(atob(accessToken.split(".")[1]));
                        const exp = new Date(payload.exp * 1000);
                        const now = new Date();
                        const timeLeft = Math.floor((exp - now) / 1000 / 60);

                        html += `<div>ë§Œë£Œ ì‹œê°„: ${exp.toLocaleString()}</div>`;
                        html += `<div>ë‚¨ì€ ì‹œê°„: ${timeLeft}ë¶„</div>`;

                        if (timeLeft < 1) {
                            html += `<div class="error">âš ï¸ í† í°ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</div>`;
                        } else if (timeLeft < 5) {
                            html += `<div class="warning">âš ï¸ í† í°ì´ ê³§ ë§Œë£Œë©ë‹ˆë‹¤!</div>`;
                        }
                    } catch (e) {
                        html += `<div class="error">âŒ í† í° ë””ì½”ë”© ì‹¤íŒ¨</div>`;
                    }
                } else {
                    html += `<div class="error">âŒ ì•¡ì„¸ìŠ¤ í† í° ì¿ í‚¤ ì—†ìŒ</div>`;
                }

                // ì‚¬ìš©ì ì •ë³´ ì¿ í‚¤ í™•ì¸
                const userInfoCookie = cookies.split("; ").find((row) => row.startsWith("userInfo="));
                if (userInfoCookie) {
                    const userInfo = userInfoCookie.split("=")[1];
                    html += `<div class="success">âœ… ì‚¬ìš©ì ì •ë³´ ì¿ í‚¤ ì¡´ì¬</div>`;
                    html += `<div class="token-display">ì‚¬ìš©ì: ${decodeURIComponent(userInfo)}</div>`;
                } else {
                    html += `<div class="error">âŒ ì‚¬ìš©ì ì •ë³´ ì¿ í‚¤ ì—†ìŒ</div>`;
                }

                const hasRefreshCookie = cookies.includes("refreshToken");
                if (hasRefreshCookie) {
                    html += `<div class="success">âœ… ë¦¬í”„ë ˆì‹œ í† í° ì¿ í‚¤ ì¡´ì¬</div>`;
                } else {
                    html += `<div class="error">âŒ ë¦¬í”„ë ˆì‹œ í† í° ì¿ í‚¤ ì—†ìŒ</div>`;
                }

                document.getElementById("tokenStatus").innerHTML = html;
            }

            function testLogin() {
                document.getElementById("loginStatus").innerHTML =
                    '<div class="warning">Google OAuth ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤...</div>';

                // Google OAuth ë¡œê·¸ì¸ ì‹œì‘
                window.location.href = "http://localhost:8000/auth/google";
            }

            async function testRefreshToken() {
                try {
                    document.getElementById("refreshStatus").innerHTML = '<div class="warning">í† í° ê°±ì‹  ì¤‘...</div>';

                    const response = await fetch("http://localhost:8000/auth/refresh", {
                        method: "POST",
                        credentials: "include",
                        headers: {
                            "Content-Type": "application/json",
                        },
                    });

                    const result = await response.json();
                    if (result.success) {
                        // ìƒˆë¡œìš´ í† í°ì€ ì¿ í‚¤ë¡œ ìë™ ì„¤ì •ë¨
                        document.getElementById(
                            "refreshStatus"
                        ).innerHTML = `<div class="success">âœ… í† í° ê°±ì‹  ì„±ê³µ!</div>
                     <div class="token-display">ì‚¬ìš©ì ì •ë³´: ${JSON.stringify(result.user)}</div>`;
                    } else {
                        document.getElementById(
                            "refreshStatus"
                        ).innerHTML = `<div class="error">âŒ í† í° ê°±ì‹  ì‹¤íŒ¨: ${result.message}</div>`;
                    }
                } catch (error) {
                    document.getElementById(
                        "refreshStatus"
                    ).innerHTML = `<div class="error">âŒ í† í° ê°±ì‹  ì˜¤ë¥˜: ${error.message}</div>`;
                }
            }

            function invalidateToken() {
                // ì¿ í‚¤ ê¸°ë°˜ì—ì„œëŠ” ì§ì ‘ í† í° ë¬´íš¨í™”ê°€ ì–´ë ¤ìš°ë¯€ë¡œ ì„¤ëª… ë³€ê²½
                document.getElementById("expiredStatus").innerHTML =
                    '<div class="warning">ì¿ í‚¤ ê¸°ë°˜ ì‹œìŠ¤í…œì—ì„œëŠ” ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬ì—ì„œ ì¿ í‚¤ë¥¼ ì‚­ì œí•˜ì—¬ í…ŒìŠ¤íŠ¸í•˜ê±°ë‚˜, ì‹œê°„ì´ ì§€ë‚˜ ìì—°ì ìœ¼ë¡œ ë§Œë£Œë˜ê¸°ë¥¼ ê¸°ë‹¤ë ¤ì•¼ í•©ë‹ˆë‹¤.</div>';
            }

            async function testExpiredToken() {
                try {
                    const response = await fetch("http://localhost:8000/auth/refresh", {
                        method: "POST",
                        credentials: "include",
                        headers: {
                            "Content-Type": "application/json",
                        },
                    });

                    const result = await response.json();

                    if (response.ok) {
                        document.getElementById("expiredStatus").innerHTML =
                            '<div class="success">âœ… í† í° ê°±ì‹  ì„±ê³µ! (ìƒˆë¡œìš´ í† í°ì´ ì¿ í‚¤ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤)</div>';
                    } else {
                        document.getElementById(
                            "expiredStatus"
                        ).innerHTML = `<div class="error">âŒ í† í° ê°±ì‹  ì‹¤íŒ¨: ${result.message}</div>`;
                    }
                } catch (error) {
                    document.getElementById(
                        "expiredStatus"
                    ).innerHTML = `<div class="error">âŒ API í˜¸ì¶œ ì˜¤ë¥˜: ${error.message}</div>`;
                }
            }

            async function testLogout() {
                try {
                    const response = await fetch("http://localhost:8000/auth/logout", {
                        method: "POST",
                        credentials: "include",
                        headers: {
                            "Content-Type": "application/json",
                        },
                    });

                    const result = await response.json();

                    if (result.success) {
                        // ì¿ í‚¤ëŠ” ë°±ì—”ë“œì—ì„œ ì‚­ì œë¨
                        document.getElementById("logoutStatus").innerHTML =
                            '<div class="success">âœ… ë¡œê·¸ì•„ì›ƒ ì„±ê³µ! ëª¨ë“  ì¿ í‚¤ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.</div>';
                    } else {
                        document.getElementById(
                            "logoutStatus"
                        ).innerHTML = `<div class="error">âŒ ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: ${result.message}</div>`;
                    }
                } catch (error) {
                    document.getElementById(
                        "logoutStatus"
                    ).innerHTML = `<div class="error">âŒ ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜: ${error.message}</div>`;
                }
            }

            function startMonitoring() {
                if (monitoringInterval) {
                    clearInterval(monitoringInterval);
                }

                document.getElementById("monitorStatus").innerHTML =
                    '<div class="warning">ìë™ ê°±ì‹  ëª¨ë‹ˆí„°ë§ ì‹œì‘...</div><div id="monitorLog"></div>';

                monitoringInterval = setInterval(async () => {
                    // ì¿ í‚¤ì—ì„œ ì•¡ì„¸ìŠ¤ í† í° ê°€ì ¸ì˜¤ê¸°
                    const cookies = document.cookie;
                    const accessTokenCookie = cookies.split("; ").find((row) => row.startsWith("accessToken="));

                    if (!accessTokenCookie) {
                        document.getElementById("monitorLog").innerHTML =
                            '<div class="error">ì•¡ì„¸ìŠ¤ í† í° ì¿ í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                        return;
                    }

                    const token = accessTokenCookie.split("=")[1];

                    try {
                        const payload = JSON.parse(atob(token.split(".")[1]));
                        const exp = new Date(payload.exp * 1000);
                        const now = new Date();
                        const timeLeft = Math.floor((exp - now) / 1000 / 60);

                        const log = document.getElementById("monitorLog");
                        log.innerHTML = `
                        <div>í˜„ì¬ ì‹œê°„: ${now.toLocaleTimeString()}</div>
                        <div>í† í° ë§Œë£Œ: ${exp.toLocaleTimeString()}</div>
                        <div>ë‚¨ì€ ì‹œê°„: ${timeLeft}ë¶„</div>
                    `;

                        // 1ë¶„ ì „ì— ìë™ ê°±ì‹  ì‹œë„
                        if (timeLeft <= 1 && timeLeft > 0) {
                            log.innerHTML += '<div class="warning">ğŸ”„ ìë™ ê°±ì‹  ì‹œë„ ì¤‘...</div>';
                            await testRefreshToken();
                        }
                    } catch (e) {
                        document.getElementById("monitorLog").innerHTML = '<div class="error">í† í° íŒŒì‹± ì˜¤ë¥˜</div>';
                    }
                }, 10000); // 10ì´ˆë§ˆë‹¤ ì²´í¬
            }

            function stopMonitoring() {
                if (monitoringInterval) {
                    clearInterval(monitoringInterval);
                    monitoringInterval = null;
                    document.getElementById("monitorStatus").innerHTML =
                        '<div class="success">ëª¨ë‹ˆí„°ë§ì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.</div>';
                }
            }

            // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ í† í° ìƒíƒœ í™•ì¸
            window.onload = function () {
                checkTokenStatus();
            };
        </script>
    </body>
</html>
