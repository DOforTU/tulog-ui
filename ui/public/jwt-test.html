<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>JWT + 리프레시 토큰 테스트</title>
        <style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
                background: #f5f5f5;
            }
            .container {
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }
            .test-section {
                margin: 20px 0;
                padding: 15px;
                border: 1px solid #ddd;
                border-radius: 5px;
            }
            .success {
                border-color: #4caf50;
                background-color: #f0fff4;
            }
            .error {
                border-color: #f44336;
                background-color: #fff5f5;
            }
            .warning {
                border-color: #ff9800;
                background-color: #fff8f0;
            }
            button {
                background: #499200;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                cursor: pointer;
                margin: 5px;
            }
            button:hover {
                background: #3d7a00;
            }
            .token-display {
                background: #f5f5f5;
                padding: 10px;
                border-radius: 3px;
                font-family: monospace;
                font-size: 12px;
                word-break: break-all;
                margin: 10px 0;
            }
            .status {
                font-weight: bold;
                margin: 10px 0;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>🔐 JWT + 리프레시 토큰 테스트</h1>

            <div class="test-section">
                <h3>1. 현재 토큰 상태</h3>
                <button onclick="checkTokenStatus()">토큰 상태 확인</button>
                <div id="tokenStatus"></div>
            </div>

            <div class="test-section">
                <h3>2. 로그인 테스트</h3>
                <p>Google OAuth 로그인을 통해 JWT 토큰을 받아보세요.</p>
                <button onclick="testLogin()">Google 로그인 테스트</button>
                <div id="loginStatus"></div>
            </div>

            <div class="test-section">
                <h3>3. 리프레시 토큰 테스트</h3>
                <p>현재 리프레시 토큰으로 새로운 액세스 토큰을 받아보세요.</p>
                <button onclick="testRefreshToken()">토큰 갱신 테스트</button>
                <div id="refreshStatus"></div>
            </div>

            <div class="test-section">
                <h3>4. 토큰 만료 시뮬레이션</h3>
                <p>토큰을 무효화하여 자동 갱신 기능을 테스트해보세요.</p>
                <button onclick="invalidateToken()">토큰 무효화</button>
                <button onclick="testExpiredToken()">만료된 토큰으로 API 호출</button>
                <div id="expiredStatus"></div>
            </div>

            <div class="test-section">
                <h3>5. 로그아웃 테스트</h3>
                <button onclick="testLogout()">로그아웃 테스트</button>
                <div id="logoutStatus"></div>
            </div>

            <div class="test-section">
                <h3>6. 자동 갱신 모니터링</h3>
                <button onclick="startMonitoring()">자동 갱신 모니터링 시작</button>
                <button onclick="stopMonitoring()">모니터링 중지</button>
                <div id="monitorStatus"></div>
            </div>
        </div>

        <script>
            let monitoringInterval;

            function checkTokenStatus() {
                const cookies = document.cookie;

                let html = '<div class="status">토큰 상태:</div>';

                // 액세스 토큰 쿠키 확인
                const accessTokenCookie = cookies.split("; ").find((row) => row.startsWith("accessToken="));
                if (accessTokenCookie) {
                    const accessToken = accessTokenCookie.split("=")[1];
                    html += `<div class="success">✅ 액세스 토큰 쿠키 존재</div>`;

                    // JWT 디코딩 (간단한 방법)
                    try {
                        const payload = JSON.parse(atob(accessToken.split(".")[1]));
                        const exp = new Date(payload.exp * 1000);
                        const now = new Date();
                        const timeLeft = Math.floor((exp - now) / 1000 / 60);

                        html += `<div>만료 시간: ${exp.toLocaleString()}</div>`;
                        html += `<div>남은 시간: ${timeLeft}분</div>`;

                        if (timeLeft < 1) {
                            html += `<div class="error">⚠️ 토큰이 만료되었습니다!</div>`;
                        } else if (timeLeft < 5) {
                            html += `<div class="warning">⚠️ 토큰이 곧 만료됩니다!</div>`;
                        }
                    } catch (e) {
                        html += `<div class="error">❌ 토큰 디코딩 실패</div>`;
                    }
                } else {
                    html += `<div class="error">❌ 액세스 토큰 쿠키 없음</div>`;
                }

                // 사용자 정보 쿠키 확인
                const userInfoCookie = cookies.split("; ").find((row) => row.startsWith("userInfo="));
                if (userInfoCookie) {
                    const userInfo = userInfoCookie.split("=")[1];
                    html += `<div class="success">✅ 사용자 정보 쿠키 존재</div>`;
                    html += `<div class="token-display">사용자: ${decodeURIComponent(userInfo)}</div>`;
                } else {
                    html += `<div class="error">❌ 사용자 정보 쿠키 없음</div>`;
                }

                const hasRefreshCookie = cookies.includes("refreshToken");
                if (hasRefreshCookie) {
                    html += `<div class="success">✅ 리프레시 토큰 쿠키 존재</div>`;
                } else {
                    html += `<div class="error">❌ 리프레시 토큰 쿠키 없음</div>`;
                }

                document.getElementById("tokenStatus").innerHTML = html;
            }

            function testLogin() {
                document.getElementById("loginStatus").innerHTML =
                    '<div class="warning">Google OAuth 로그인 페이지로 이동합니다...</div>';

                // Google OAuth 로그인 시작
                window.location.href = "http://localhost:8000/auth/google";
            }

            async function testRefreshToken() {
                try {
                    document.getElementById("refreshStatus").innerHTML = '<div class="warning">토큰 갱신 중...</div>';

                    const response = await fetch("http://localhost:8000/auth/refresh", {
                        method: "POST",
                        credentials: "include",
                        headers: {
                            "Content-Type": "application/json",
                        },
                    });

                    const result = await response.json();
                    if (result.success) {
                        // 새로운 토큰은 쿠키로 자동 설정됨
                        document.getElementById(
                            "refreshStatus"
                        ).innerHTML = `<div class="success">✅ 토큰 갱신 성공!</div>
                     <div class="token-display">사용자 정보: ${JSON.stringify(result.user)}</div>`;
                    } else {
                        document.getElementById(
                            "refreshStatus"
                        ).innerHTML = `<div class="error">❌ 토큰 갱신 실패: ${result.message}</div>`;
                    }
                } catch (error) {
                    document.getElementById(
                        "refreshStatus"
                    ).innerHTML = `<div class="error">❌ 토큰 갱신 오류: ${error.message}</div>`;
                }
            }

            function invalidateToken() {
                // 쿠키 기반에서는 직접 토큰 무효화가 어려우므로 설명 변경
                document.getElementById("expiredStatus").innerHTML =
                    '<div class="warning">쿠키 기반 시스템에서는 브라우저 개발자 도구에서 쿠키를 삭제하여 테스트하거나, 시간이 지나 자연적으로 만료되기를 기다려야 합니다.</div>';
            }

            async function testExpiredToken() {
                try {
                    const response = await fetch("http://localhost:8000/auth/refresh", {
                        method: "POST",
                        credentials: "include",
                        headers: {
                            "Content-Type": "application/json",
                        },
                    });

                    const result = await response.json();

                    if (response.ok) {
                        document.getElementById("expiredStatus").innerHTML =
                            '<div class="success">✅ 토큰 갱신 성공! (새로운 토큰이 쿠키로 설정되었습니다)</div>';
                    } else {
                        document.getElementById(
                            "expiredStatus"
                        ).innerHTML = `<div class="error">❌ 토큰 갱신 실패: ${result.message}</div>`;
                    }
                } catch (error) {
                    document.getElementById(
                        "expiredStatus"
                    ).innerHTML = `<div class="error">❌ API 호출 오류: ${error.message}</div>`;
                }
            }

            async function testLogout() {
                try {
                    const response = await fetch("http://localhost:8000/auth/logout", {
                        method: "POST",
                        credentials: "include",
                        headers: {
                            "Content-Type": "application/json",
                        },
                    });

                    const result = await response.json();

                    if (result.success) {
                        // 쿠키는 백엔드에서 삭제됨
                        document.getElementById("logoutStatus").innerHTML =
                            '<div class="success">✅ 로그아웃 성공! 모든 쿠키가 삭제되었습니다.</div>';
                    } else {
                        document.getElementById(
                            "logoutStatus"
                        ).innerHTML = `<div class="error">❌ 로그아웃 실패: ${result.message}</div>`;
                    }
                } catch (error) {
                    document.getElementById(
                        "logoutStatus"
                    ).innerHTML = `<div class="error">❌ 로그아웃 오류: ${error.message}</div>`;
                }
            }

            function startMonitoring() {
                if (monitoringInterval) {
                    clearInterval(monitoringInterval);
                }

                document.getElementById("monitorStatus").innerHTML =
                    '<div class="warning">자동 갱신 모니터링 시작...</div><div id="monitorLog"></div>';

                monitoringInterval = setInterval(async () => {
                    // 쿠키에서 액세스 토큰 가져오기
                    const cookies = document.cookie;
                    const accessTokenCookie = cookies.split("; ").find((row) => row.startsWith("accessToken="));

                    if (!accessTokenCookie) {
                        document.getElementById("monitorLog").innerHTML =
                            '<div class="error">액세스 토큰 쿠키가 없습니다.</div>';
                        return;
                    }

                    const token = accessTokenCookie.split("=")[1];

                    try {
                        const payload = JSON.parse(atob(token.split(".")[1]));
                        const exp = new Date(payload.exp * 1000);
                        const now = new Date();
                        const timeLeft = Math.floor((exp - now) / 1000 / 60);

                        const log = document.getElementById("monitorLog");
                        log.innerHTML = `
                        <div>현재 시간: ${now.toLocaleTimeString()}</div>
                        <div>토큰 만료: ${exp.toLocaleTimeString()}</div>
                        <div>남은 시간: ${timeLeft}분</div>
                    `;

                        // 1분 전에 자동 갱신 시도
                        if (timeLeft <= 1 && timeLeft > 0) {
                            log.innerHTML += '<div class="warning">🔄 자동 갱신 시도 중...</div>';
                            await testRefreshToken();
                        }
                    } catch (e) {
                        document.getElementById("monitorLog").innerHTML = '<div class="error">토큰 파싱 오류</div>';
                    }
                }, 10000); // 10초마다 체크
            }

            function stopMonitoring() {
                if (monitoringInterval) {
                    clearInterval(monitoringInterval);
                    monitoringInterval = null;
                    document.getElementById("monitorStatus").innerHTML =
                        '<div class="success">모니터링이 중지되었습니다.</div>';
                }
            }

            // 페이지 로드 시 자동으로 토큰 상태 확인
            window.onload = function () {
                checkTokenStatus();
            };
        </script>
    </body>
</html>
